# This workflow is responsible for all kinds of integration tests run on pull request.
# Those tests depend on a container image so in the first job we wait for the image build to succeed.

name: Main Integration

on:
  pull_request:
    types: [ synchronize, opened, reopened, ready_for_review ]
    branches:
      - main
  schedule:
    - cron: '* * * * *'
#    - cron: '0 5 * * *' # Run every day at 05:00 AM

jobs:
  wait-for-image-build:
    name: Wait for image build
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.get-sha.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: get-sha
        run: |
          if [ "${{ github.event_name }}" != "schedule" ]; then
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "sha=$(./scripts/get_latest_build_sha.sh)" >> $GITHUB_OUTPUT
          fi

  print-sha:
    name: print-sha
    runs-on: ubuntu-latest
    needs: [wait-for-image-build]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: print-sha
        run: |
          echo "${{ needs.wait-for-image-build.outputs.sha }}"
