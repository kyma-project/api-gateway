name: Release Pull Request

on:
  pull_request_target:
    types: [ synchronize, opened, reopened, ready_for_review ]
    branches:
      - 'release-**'

jobs:
  build-image:
    name: Build manager image
    uses: kyma-project/test-infra/.github/workflows/image-builder.yml@main
    if: github.event.pull_request.draft == false
    with:
      name: api-gateway-manager
      dockerfile: Dockerfile
      context: .
      build-args: |
        VERSION=PR-${{ github.event.number }}

  unit-tests:
    name: Unit tests & lint
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/pull-unit-lint.yaml
    secrets: inherit

  integration-tests:
    name: Integration tests
    needs: [ build-image ]
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/pull-integration-release.yaml
    secrets: inherit

  ui-tests:
    name: UI tests
    needs: [build-image]
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/ui-tests.yaml
    secrets: inherit

  verify-pins:
    name: Verify-commit-pins
    if: github.event.pull_request.draft == false
    uses: ./.github/workflows/verify-commit-pins.yaml
    secrets: inherit

  pull-request-status:
    needs: [ build-image, unit-tests, integration-tests, ui-tests, verify-pins ]
    runs-on: ubuntu-latest
    steps:
      - if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: exit 0
      - if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1