apiVersion: v1
kind: Pod
metadata:
  name: mock-oauth2-server
  namespace: {{ .Namespace }}
  labels:
    app: mock-oauth2-server
spec:
  containers:
    - name: mock-oauth2-server
      image: ghcr.io/navikt/mock-oauth2-server:2.0.0
      imagePullPolicy: IfNotPresent
      ports:
        - containerPort: 8080
          name: http
          protocol: TCP
      env:
        - name: JSON_CONFIG
          value: |
            {
                "interactiveLogin": false,
                "httpServer": "NettyWrapper",
                "tokenCallbacks": [
                    {
                        "issuerId": "default",
                        "tokenExpiry": 600,
                        "requestMappings": [
                            {
                                "requestParam": "scope",
                                "match": "read",
                                "claims": {
                                    "sub": "test",
            						"scope": "read write",
                                    "aud": [
                                        "https://example.com/user",
            							"https://example.com"
                                    ]
                                }
                            }
                        ]
                    }
                ]
            }
  restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: mock-oauth2-server
  namespace: {{ .Namespace }}
spec:
  selector:
    app: mock-oauth2-server
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
  type: NodePort
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  labels:
    app: mock-oauth2-server
  name: mock-oauth2-server
  namespace: {{ .Namespace }}
spec:
  gateways:
    - kyma-system/kyma-gateway
  hosts:
    - oauth2-mock.{{ .Domain }}
  http:
    - route:
        - destination:
            host: mock-oauth2-server.{{ .Namespace }}.svc.cluster.local
            port:
              number: 80
  